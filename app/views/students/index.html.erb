<div class="admin-block">


  <h1>
    Students - <%= Student.count_all %> คน
    <%= link_to 'New Student', new_student_path , class: 'btn-ner'%>
  </h1>

  <div class="modal">
  <div class="modal-background"></div>

    <form class="modal-card" action="<%= home_update_course_path %>" method="get">
      <input class="st-id" type="hidden" name="student" value="">
      <header class="modal-card-head">
        <p class="modal-card-title">ลงวิชาเรียนเพิ่ม</p>
        <button class="delete closer"></button>
      </header>
      <section class="modal-card-body">
        <!-- Content ... -->
        <div class="st-name"></div>
        <div class="st-course" style="margin-bottom: 16px;"></div>
        <table>
          <thead>
            <tr>
              <th>เลือก</th>
              <th>รหัสวิชา</th>
              <th>รายชื่อวิชา</th>
            </tr>
          </thead>
          <tbody class="pop-course">
            <% Classroom.all.each do |c| %>
              <tr>
                <td><input type="checkbox" name="[course]<%= c[:spec] %>" value="" course="<%= c[:spec] %>"> </td>
                <td><%= c[:spec] %></td>
                <td><%= c[:name] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </section>
      <footer class="modal-card-foot">
        <input type="submit" class="button is-success" value="อัพเดทข้อมูล">
        <a class="button closer">ยกเลิก</a>
      </footer>
    </form>
</div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>รายชื่อ</th>
        <th>ชั้นปี</th>
        <th>คอร์สที่ลง</th>
        <th>โรงเรียน</th>
        <th>ผู้ปกครอง</th>
        <th>Email</th>
        <th>เบอร์โทร</th>
        <th>Line</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% (@students.sort_by {|s| s[:grade]}).each do |student| %>
        <% student_detail = Student.details(student) %>
        <tr>
          <td><%= student[:student_code] %></td>
          <td><%= student_detail[:name] %></td>
          <td><%= student_detail[:grade] %></td>
          <td><%= student_detail[:seat][:c] %> วิชา</td>
          <td><%= student_detail[:school] %></td>
          <td><%= student_detail[:parent] %></td>
          <td><%= student_detail[:email] %></td>
          <td><%= student_detail[:tel] %></td>
          <td><%= student_detail[:line] %></td>
          <td>
            <a
              class="open-modal btn btn-default btn-redder"
              href="#" student="<%= student[:student_code] %>"
              name="<%= student_detail[:name] %>"
              grade="<%= student_detail[:grade] %>"
              school="<%= student_detail[:school] %>">
              +เพิ่มวิชา
            </a>
          </td>
          <td><%= link_to 'Edit', edit_student_path(student) %></td>
          <td><%= link_to 'Destroy', student, method: :delete, data: { confirm: 'Are you sure?' } %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <br>
</div>
<p id="notice"><%= notice %></p>

<script type="text/javascript">
  $( document ).ready(function() {
    $('.open-modal').on('click',function(){
      $('.modal').addClass('is-active');
      gs = $(this).attr("student");
      gg = $(this).attr("grade");
      gn = $(this).attr("name");
      gschool = $(this).attr("school");
      $('.st-name').text(gn + " | " + gg + " โรงเรียน" + gschool);
      $('.st-id').val(gs);
      //alert(gs);
      $.ajax({
				url: '<%= init_get_subscription_path %>',
        data: {
          student_code: gs
        },
				success: function(response){
          $('.st-course').text(response.get);
          $("tbody.pop-course").find("tr").each(function() {
            //find course then checked
            var courses     = $(this).find('input');
            //clear all value
            courses.prop('checked', false);
            var find_course = response.get.indexOf(courses.attr('course'));
            if (find_course >= 0) {
              //alert(find_course);
              courses.prop('checked', true);
            }
          });
				}
			});
    });

    $('.closer').on('click',function(){
      $('.modal').removeClass('is-active');
    });
  });
</script>
